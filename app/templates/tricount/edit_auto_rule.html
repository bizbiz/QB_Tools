{% extends "base.html" %}

{% block title %}QB Tools - Modifier une règle d'auto-catégorisation{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tricount/main.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/tricount/auto_categorize.css') }}">
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.home') }}">Accueil</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('tricount.index') }}">Tricount Helper</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('tricount.auto_rules_list') }}">Règles d'auto-catégorisation</a></li>
                    <li class="breadcrumb-item active">Modifier une règle</li>
                </ol>
            </nav>
            
            <h1>Modifier une règle d'auto-catégorisation</h1>
            <p class="lead">Modifiez les paramètres de la règle "{{ rule.name }}"</p>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h3 class="card-title">Configuration de la règle</h3>
                </div>
                <div class="card-body">
                    <form id="rule-form" action="{{ url_for('tricount.edit_auto_rule', rule_id=rule.id) }}" method="POST">
                        <div class="mb-3">
                            <label for="rule-name" class="form-label">Nom de la règle</label>
                            <input type="text" class="form-control rule-input" id="rule-name" name="rule_name" value="{{ rule.name }}">
                        </div>
                        
                        <h4 class="mt-4">Filtres</h4>
                        
                        <div class="mb-3">
                            <label for="merchant-contains" class="form-label">Le marchand contient</label>
                            <input type="text" class="form-control rule-input" id="merchant-contains" name="merchant_contains" value="{{ rule.merchant_contains }}">
                            <div class="form-text">Cette règle s'appliquera aux dépenses dont le nom du marchand contient ce texte.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description-contains" class="form-label">La description contient (optionnel)</label>
                            <input type="text" class="form-control rule-input" id="description-contains" name="description_contains" value="{{ rule.description_contains or '' }}">
                            <div class="form-text">Vous pouvez ajouter une condition sur la description pour être plus précis.</div>
                        </div>
                        
                        <h4 class="mt-4">Filtres de montant (optionnel)</h4>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="min-amount" class="form-label">Montant minimum</label>
                                <div class="input-group">
                                    <input type="number" step="0.01" min="0" class="form-control rule-input" id="min-amount" name="min_amount" value="{{ "%.2f"|format(rule.min_amount) if rule.min_amount else '' }}">
                                    <span class="input-group-text">€</span>
                                </div>
                                <div class="form-text">Filtre les dépenses dont le montant est supérieur ou égal à cette valeur</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="max-amount" class="form-label">Montant maximum</label>
                                <div class="input-group">
                                    <input type="number" step="0.01" min="0" class="form-control rule-input" id="max-amount" name="max_amount" value="{{ "%.2f"|format(rule.max_amount) if rule.max_amount else '' }}">
                                    <span class="input-group-text">€</span>
                                </div>
                                <div class="form-text">Filtre les dépenses dont le montant est inférieur ou égal à cette valeur</div>
                            </div>
                        </div>
                        
                        <h4 class="mt-4">Actions à appliquer</h4>
                        
                        <!-- Section Type de dépense -->
                        <div id="flag-section" class="rule-action-section mb-4">
                            <div class="section-header">
                                <h5 class="mb-0">Type de dépense</h5>
                                <div class="form-check form-switch">
                                    <input class="form-check-input rule-input" type="checkbox" id="apply-flag" name="apply_flag" value="true" {% if rule.apply_flag %}checked{% endif %}>
                                    <label class="form-check-label" for="apply-flag">
                                        <i class="fas fa-tag me-1"></i> Appliquer un type
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3 flag-content">
                                <label for="flag-id" class="form-label">Type de dépense</label>
                                <select class="form-select rule-input" id="flag-id" name="flag_id" {% if not rule.apply_flag %}disabled{% endif %}>
                                    <option value="">Choisir un type de dépense</option>
                                    {% for flag in flags %}
                                    <option value="{{ flag.id }}" {% if rule.flag_id == flag.id %}selected{% endif %}>
                                        {{ flag.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="mt-2">
                                    <div id="flag-preview" class="d-flex align-items-center mt-2">
                                        {% if rule.flag %}
                                        <span class="flag-badge" style="background-color: {{ rule.flag.color }}; color: white; padding: 4px 12px; border-radius: 20px; display: inline-flex; align-items: center;">
                                            <i class="fas {{ rule.flag.icon }} me-2"></i>
                                            {{ rule.flag.name }}
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Section Catégorie -->
                        <div id="category-section" class="rule-action-section mb-4">
                            <div class="section-header">
                                <h5 class="mb-0">Catégorie</h5>
                                <div class="form-check form-switch">
                                    <input class="form-check-input rule-input" type="checkbox" id="apply-category" name="apply_category" value="true" {% if rule.apply_category %}checked{% endif %}>
                                    <label class="form-check-label" for="apply-category">
                                        <i class="fas fa-folder-open me-1"></i> Catégoriser
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3 category-content">
                                <label for="category-id" class="form-label">Catégorie</label>
                                <select class="form-select rule-input" id="category-id" name="category_id" {% if not rule.apply_category %}disabled{% endif %}>
                                    <option value="">Choisir une catégorie</option>
                                    {% for category in categories|sort(attribute='name') %}
                                    <option value="{{ category.id }}" {% if rule.category_id == category.id %}selected{% endif %}>{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <!-- Section Renommage -->
                        <div id="rename-section" class="rule-action-section mb-4" {% if not rule.apply_rename %}style="display: none;"{% endif %}>
                            <div class="section-header">
                                <h5 class="mb-0">Renommage</h5>
                                <div class="form-check form-switch">
                                    <input class="form-check-input rule-input" type="checkbox" id="apply-rename" name="apply_rename" value="true" {% if rule.apply_rename %}checked{% endif %}>
                                    <label class="form-check-label" for="apply-rename">
                                        <i class="fas fa-edit me-1"></i> Renommer
                                    </label>
                                </div>
                            </div>
                            
                            <div class="rename-content">
                                <div class="mb-3">
                                    <label for="rename-pattern" class="form-label">Motif à rechercher</label>
                                    <input type="text" class="form-control rule-input" id="rename-pattern" name="rename_pattern" value="{{ rule.rename_pattern or '' }}" {% if not rule.apply_rename %}disabled{% endif %}>
                                    <div class="form-text">Texte à rechercher dans le nom du marchand. Peut être une expression régulière.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="rename-replacement" class="form-label">Texte de remplacement</label>
                                    <input type="text" class="form-control rule-input" id="rename-replacement" name="rename_replacement" value="{{ rule.rename_replacement or '' }}" {% if not rule.apply_rename %}disabled{% endif %}>
                                    <div class="form-text">Texte qui remplacera le motif trouvé. Laissez vide pour supprimer le motif.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="alert alert-info">
                                        <strong>Aperçu:</strong> <span id="rename-preview">{{ example_merchant }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input rule-input" type="checkbox" id="requires-confirmation" name="requires_confirmation" {% if rule.requires_confirmation %}checked{% endif %} value="true">
                                <label class="form-check-label" for="requires-confirmation">
                                    Nécessite une confirmation avant application
                                </label>
                                <div class="form-text">Si activé, la règle ne sera pas appliquée automatiquement aux nouvelles dépenses et nécessitera une confirmation manuelle.</div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Enregistrer les modifications
                            </button>
                            <a href="{{ url_for('tricount.auto_rules_list') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Retour
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Données des flags pour l'affichage et la manipulation en JavaScript
    window.flagData = {
        {% for flag in flags %}
        "{{ flag.id }}": {
            name: "{{ flag.name }}",
            color: "{{ flag.color }}",
            icon: "{{ flag.icon }}"
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    };
    
    // Information sur les catégories et les flags associés
    window.categoryData = {
        {% for category in categories %}
        "{{ category.id }}": {
            name: "{{ category.name }}",
            flagIds: [{% for flag in category.flags %}{{ flag.id }}{% if not loop.last %},{% endif %}{% endfor %}]
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    };
    
    document.addEventListener('DOMContentLoaded', function() {
        // Sélectionner les éléments du DOM
        const applyCategoryCheckbox = document.getElementById('apply-category');
        const applyFlagCheckbox = document.getElementById('apply-flag');
        const applyRenameCheckbox = document.getElementById('apply-rename');
        
        const categorySection = document.getElementById('category-section');
        const flagSection = document.getElementById('flag-section');
        const renameSection = document.getElementById('rename-section');
        
        // Fonction pour mettre à jour l'état des sections
        function updateSectionState() {
            // Section Catégorie
            if (categorySection && applyCategoryCheckbox) {
                const inputs = categorySection.querySelectorAll('input:not([type="checkbox"]), select');
                
                if (applyCategoryCheckbox.checked) {
                    categorySection.classList.remove('disabled-section');
                    inputs.forEach(input => { input.disabled = false; });
                } else {
                    categorySection.classList.add('disabled-section');
                    inputs.forEach(input => { input.disabled = true; });
                }
            }
            
            // Section Flag
            if (flagSection && applyFlagCheckbox) {
                const inputs = flagSection.querySelectorAll('input:not([type="checkbox"]), select');
                
                if (applyFlagCheckbox.checked) {
                    flagSection.classList.remove('disabled-section');
                    inputs.forEach(input => { input.disabled = false; });
                } else {
                    flagSection.classList.add('disabled-section');
                    inputs.forEach(input => { input.disabled = true; });
                }
            }
            
            // Section Renommage
            if (renameSection && applyRenameCheckbox) {
                const inputs = renameSection.querySelectorAll('input:not([type="checkbox"]), select');
                
                if (applyRenameCheckbox.checked) {
                    renameSection.classList.remove('disabled-section');
                    renameSection.style.display = 'block';
                    inputs.forEach(input => { input.disabled = false; });
                } else {
                    renameSection.classList.add('disabled-section');
                    renameSection.style.display = 'none';
                    inputs.forEach(input => { input.disabled = true; });
                }
            }
        }
        
        // Mettre à jour la prévisualisation du flag
        function updateFlagPreview() {
            const flagSelect = document.getElementById('flag-id');
            const flagPreview = document.getElementById('flag-preview');
            
            if (!flagPreview || !flagSelect) return;
            
            const flagId = flagSelect.value;
            flagPreview.innerHTML = '';
            
            if (flagId && window.flagData && window.flagData[flagId]) {
                const flag = window.flagData[flagId];
                
                // Créer le badge de prévisualisation
                const badge = document.createElement('span');
                badge.className = 'flag-badge me-2';
                badge.style.backgroundColor = flag.color;
                badge.style.color = 'white';
                badge.style.padding = '4px 12px';
                badge.style.borderRadius = '20px';
                badge.style.display = 'inline-flex';
                badge.style.alignItems = 'center';
                
                // Ajouter l'icône
                const icon = document.createElement('i');
                icon.className = `fas ${flag.icon} me-2`;
                badge.appendChild(icon);
                
                // Ajouter le nom
                const nameSpan = document.createElement('span');
                nameSpan.textContent = flag.name;
                badge.appendChild(nameSpan);
                
                flagPreview.appendChild(badge);
            }
        }
        
        // Mettre à jour l'aperçu de renommage
        function updateRenamePreview() {
            const renamePattern = document.getElementById('rename-pattern');
            const renameReplacement = document.getElementById('rename-replacement');
            const renamePreview = document.getElementById('rename-preview');
            
            if (!renamePattern || !renameReplacement || !renamePreview) return;
            
            // Exemple de texte pour l'aperçu
            const originalText = "{{ rule.merchant_contains }}";
            
            try {
                if (renamePattern.value) {
                    const regex = new RegExp(renamePattern.value, 'g');
                    renamePreview.textContent = originalText.replace(regex, renameReplacement.value || '');
                } else {
                    renamePreview.textContent = originalText;
                }
            } catch (e) {
                renamePreview.textContent = "Erreur: " + e.message;
            }
        }
        
        // Ajouter les écouteurs d'événements
        if (applyCategoryCheckbox) {
            applyCategoryCheckbox.addEventListener('change', updateSectionState);
        }
        
        if (applyFlagCheckbox) {
            applyFlagCheckbox.addEventListener('change', updateSectionState);
        }
        
        if (applyRenameCheckbox) {
            applyRenameCheckbox.addEventListener('change', updateSectionState);
        }
        
        // Écouteurs pour la prévisualisation du flag
        const flagSelect = document.getElementById('flag-id');
        if (flagSelect) {
            flagSelect.addEventListener('change', updateFlagPreview);
            // Initialiser la prévisualisation
            updateFlagPreview();
        }
        
        // Écouteurs pour la prévisualisation du renommage
        const renamePattern = document.getElementById('rename-pattern');
        const renameReplacement = document.getElementById('rename-replacement');
        
        if (renamePattern && renameReplacement) {
            renamePattern.addEventListener('input', updateRenamePreview);
            renameReplacement.addEventListener('input', updateRenamePreview);
            // Initialiser la prévisualisation
            updateRenamePreview();
        }
        
        // Initialiser l'état des sections
        updateSectionState();
    });
</script>
{% endblock %}