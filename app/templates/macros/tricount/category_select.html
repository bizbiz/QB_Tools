{# app/templates/macros/tricount/category_select.html #}

{# Macro pour g√©n√©rer un badge de cat√©gorie coh√©rent dans toute l'application #}
{% macro category_badge(category, extra_classes='') %}
<span class="category-badge {{ extra_classes }}" style="border-color: {{ category.color }};">
    {% if category.iconify_id %}
    <span class="iconify me-2" data-icon="{{ category.iconify_id }}"></span>
    {% elif category.icon %}
    <span class="me-2">{{ category.get_icon_emoji }}</span>
    {% elif category.legacy_icon %}
    <i class="fas {{ category.legacy_icon }} me-2"></i>
    {% endif %}
    {{ category.name }}
</span>
{% endmacro %}

{# Version simplifi√©e pour l'aper√ßu en √©dition ou cr√©ation #}
{% macro category_badge_preview(name, color='#e9ecef', emoji=None, icon_class=None, iconify_id=None, extra_classes='', id=None) %}
<span class="category-badge {{ extra_classes }}" style="border-color: {{ color }};" {% if id %}id="{{ id }}"{% endif %}>
    {% if iconify_id %}
    <span class="iconify me-2" data-icon="{{ iconify_id }}"></span>
    {% elif emoji %}
    <span class="me-2">{{ emoji }}</span>
    {% elif icon_class %}
    <i class="fas {{ icon_class }} me-2"></i>
    {% else %}
    <i class="fas fa-folder me-2"></i>
    {% endif %}
    {{ name }}
</span>
{% endmacro %}

{# Macro simple pour s√©lectionner une cat√©gorie (filtrage c√¥t√© serveur) #}
{% macro category_select(name='category_id', id=None, selected_category=None, selected_flag=None, classes='', required=False, placeholder='Choisir une cat√©gorie', all_categories=None, show_icons=True) %}
    {# G√©n√©rer un ID unique si non fourni #}
    {% set select_id = id if id else 'category-' ~ name %}
    
    {# Trier les cat√©gories par ordre alphab√©tique #}
    {% set sorted_categories = all_categories|sort(attribute='name') %}

    <select name="{{ name }}" id="{{ select_id }}" class="form-select {{ classes }}" {% if required %}required{% endif %}>
        <option value="">{{ placeholder }}</option>
        
        {% for category in sorted_categories %}
            {% set display = true %}
            
            {# Si un flag est s√©lectionn√©, ne montrer que les cat√©gories compatibles #}
            {% if selected_flag and category.flags %}
                {% set display = false %}
                {% for flag in category.flags %}
                    {% if flag.id == selected_flag %}
                        {% set display = true %}
                    {% endif %}
                {% endfor %}
            {% endif %}
            
            {% if display %}
                <option value="{{ category.id }}" {% if selected_category == category.id %}selected{% endif %}>
                    {% if show_icons %}
                        {% if category.iconify_id %}
                            {{ category.iconify_id|truncate(2, true, '') }} 
                        {% elif category.icon %}
                            {{ category.get_icon_emoji }} 
                        {% elif category.legacy_icon %}
                            <i class="fas {{ category.legacy_icon }}"></i> 
                        {% endif %}
                    {% endif %}
                    {{ category.name }}
                </option>
            {% endif %}
        {% endfor %}
    </select>
{% endmacro %}

{# Macro avec support JavaScript pour filtrage dynamique et ic√¥nes am√©lior√©es #}
{% macro category_select_with_js(name='category_id', id=None, selected_category=None, classes='', required=False, placeholder='Choisir une cat√©gorie', all_categories=None, show_icons=True, flag_select_id=None) %}
    {# G√©n√©rer un ID unique si non fourni #}
    {% set select_id = id if id else 'category-' ~ name %}
    
    {# Trier les cat√©gories par ordre alphab√©tique #}
    {% set sorted_categories = all_categories|sort(attribute='name') %}

    <select name="{{ name }}" 
            id="{{ select_id }}" 
            class="form-select category-select {{ classes }}" 
            data-category-select="true"
            data-placeholder="{{ placeholder }}"
            {% if flag_select_id %}data-flag-select="{{ flag_select_id }}"{% endif %}
            {% if required %}required{% endif %}>
        <option value="">{{ placeholder }}</option>
        
        {% for category in sorted_categories %}
            <option value="{{ category.id }}" 
                    {% if selected_category == category.id %}selected{% endif %}
                    data-flags="[{% for flag in category.flags %}{{ flag.id }}{% if not loop.last %},{% endif %}{% endfor %}]"
                    data-color="{{ category.color }}"
                    {% if category.iconify_id %}
                        data-iconify-id="{{ category.iconify_id }}"
                    {% elif category.icon %}
                        data-icon-emoji="{{ category.get_icon_emoji }}"
                    {% elif category.legacy_icon %}
                        data-icon-class="{{ category.legacy_icon }}"
                    {% endif %}>
                {% if show_icons %}
                    {% if category.iconify_id %}
                        üîπ 
                    {% elif category.icon %}
                        {{ category.get_icon_emoji }} 
                    {% elif category.legacy_icon %}
                        üî∏ 
                    {% endif %}
                {% endif %}
                {{ category.name }}
            </option>
        {% endfor %}
    </select>

    <style>
    /* Styles sp√©cifiques au select de cat√©gories */
    #{{ select_id }} option {
        padding: 8px;
    }
    
    #{{ select_id }} option:checked {
        background-color: #e7f3ff;
        font-weight: bold;
    }
    </style>
{% endmacro %}